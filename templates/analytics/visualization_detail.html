{% extends 'base.html' %}

{% block title %}{{ visualization.title }} - Analytics{% endblock %}

{% block page_title %}{{ visualization.title }}{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Overview Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon purple">
                <i class="ri-bar-chart-box-line"></i>
            </div>
            <div>
                <div class="text-2 mb-1">Chart Type</div>
                <div class="fw-semibold">{{ visualization.chart_type|title }}</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon green">
                <i class="ri-database-2-line"></i>
            </div>
            <div>
                <div class="text-2 mb-1">Dataset</div>
                <div class="fw-semibold">{{ dataset.title }}</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon blue">
                <i class="ri-time-line"></i>
            </div>
            <div>
                <div class="text-2 mb-1">Last Updated</div>
                <div class="fw-semibold">{{ visualization.updated_at|date:"M d, Y" }}</div>
            </div>
        </div>
    </div>

    <!-- Main Visualization Card -->
    <div class="widget-card mb-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="h5 mb-1">Visualization Preview</h2>
                <p class="text-2 m-0">{{ visualization.description }}</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-icon" onclick="toggleFullscreen()" title="Fullscreen">
                    <i class="ri-fullscreen-line"></i>
                </button>
                <button class="btn btn-icon" onclick="refreshChart()" title="Refresh">
                    <i class="ri-refresh-line"></i>
                </button>
                <button class="btn btn-icon" onclick="downloadChart()" title="Download">
                    <i class="ri-download-line"></i>
                </button>
                <button class="btn btn-primary" onclick="shareVisualization()">
                    <i class="ri-share-line"></i>
                    Share
                </button>
            </div>
        </div>
        
        <!-- Chart Container -->
        <div class="position-relative" style="height: 400px;">
            <canvas id="visualizationChart"></canvas>
            <div id="chartSpinner" class="position-absolute top-50 start-50 translate-middle d-none">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <!-- Tabs Section -->
    <div class="widget-card">
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#details-tab" type="button">
                    <i class="ri-information-line me-2"></i>Details
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#data-tab" type="button">
                    <i class="ri-table-line me-2"></i>Data
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#settings-tab" type="button">
                    <i class="ri-settings-3-line me-2"></i>Settings
                </button>
            </li>
        </ul>

        <div class="tab-content mt-4">
            <!-- Details Tab -->
            <div class="tab-pane fade show active" id="details-tab">
                <div class="row g-4">
                    <div class="col-md-6">
                        <h3 class="h6 mb-3">Visualization Information</h3>
                        <div class="d-flex flex-column gap-3">
                            <div class="d-flex align-items-center p-3 rounded" style="background: var(--surface-2);">
                                <i class="ri-chart-line text-primary me-3"></i>
                                <div>
                                    <div class="text-2">Chart Type</div>
                                    <div class="fw-medium">{{ visualization.chart_type|title }}</div>
                                </div>
                            </div>
                            <div class="d-flex align-items-center p-3 rounded" style="background: var(--surface-2);">
                                <i class="ri-database-2-line text-primary me-3"></i>
                                <div>
                                    <div class="text-2">Dataset</div>
                                    <a href="{% url 'analytics:dataset_detail' dataset.uuid %}" class="text-primary fw-medium">
                                        {{ dataset.title }}
                                    </a>
                                </div>
                            </div>
                            <div class="d-flex align-items-center p-3 rounded" style="background: var(--surface-2);">
                                <i class="ri-user-line text-primary me-3"></i>
                                <div>
                                    <div class="text-2">Created By</div>
                                    <div class="fw-medium">{{ visualization.dataset.creator.get_full_name }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h3 class="h6 mb-3">Data Configuration</h3>
                        <div class="d-flex flex-column gap-3">
                            <div class="d-flex align-items-center p-3 rounded" style="background: var(--surface-2);">
                                <i class="ri-arrow-left-right-line text-primary me-3"></i>
                                <div>
                                    <div class="text-2">X-Axis</div>
                                    <div class="fw-medium">{{ visualization.x_axis }}</div>
                                </div>
                            </div>
                            <div class="d-flex align-items-center p-3 rounded" style="background: var(--surface-2);">
                                <i class="ri-arrow-up-down-line text-primary me-3"></i>
                                <div>
                                    <div class="text-2">Y-Axis</div>
                                    <div class="fw-medium">{{ visualization.y_axis }}</div>
                                </div>
                            </div>
                            <div class="d-flex align-items-center p-3 rounded" style="background: var(--surface-2);">
                                <i class="ri-timer-line text-primary me-3"></i>
                                <div>
                                    <div class="text-2">Last Updated</div>
                                    <div class="fw-medium">{{ visualization.updated_at|date:"M d, Y H:i" }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Tab -->
            <div class="tab-pane fade" id="data-tab">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>{{ visualization.x_axis }}</th>
                                <th>{{ visualization.y_axis }}</th>
                                <th>Value</th>
                            </tr>
                        </thead>
                        <tbody id="dataTable">
                            <!-- Data will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-pane fade" id="settings-tab">
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Chart Style</label>
                            <select class="form-select" id="chartStyle">
                                <option value="default">Default</option>
                                <option value="minimal">Minimal</option>
                                <option value="modern">Modern</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Color Scheme</label>
                            <select class="form-select" id="colorScheme">
                                <option value="default">Default</option>
                                <option value="monochrome">Monochrome</option>
                                <option value="gradient">Gradient</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Animation Speed</label>
                            <input type="range" class="form-range" id="animationSpeed" min="0" max="2" step="0.1" value="1">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Show Legend</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="showLegend" checked>
                                <label class="form-check-label" for="showLegend">Enable</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let chart;
    
    function initChart() {
        const ctx = document.getElementById('visualizationChart').getContext('2d');
        chart = new Chart(ctx, {
            type: '{{ visualization.chart_type }}',
            data: {
                // Data will be populated dynamically
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: '{{ visualization.title }}'
                    }
                }
            }
        });
    }

    function toggleFullscreen() {
        const chartContainer = document.querySelector('.widget-card');
        if (!document.fullscreenElement) {
            chartContainer.requestFullscreen();
        } else {
            document.exitFullscreen();
        }
    }

    function downloadChart() {
        const link = document.createElement('a');
        link.download = '{{ visualization.title }}.png';
        link.href = chart.toBase64Image();
        link.click();
    }

    function refreshChart() {
        const spinner = document.getElementById('chartSpinner');
        spinner.classList.remove('d-none');
        
        // Simulate data refresh
        setTimeout(() => {
            spinner.classList.add('d-none');
            // Update chart data here
        }, 1000);
    }

    function shareVisualization() {
        // Implement sharing functionality
        alert('Sharing functionality will be implemented here');
    }

    // Initialize chart when the page loads
    document.addEventListener('DOMContentLoaded', initChart);

    // Handle settings changes
    document.getElementById('chartStyle').addEventListener('change', function(e) {
        // Update chart style
    });

    document.getElementById('colorScheme').addEventListener('change', function(e) {
        // Update color scheme
    });

    document.getElementById('animationSpeed').addEventListener('input', function(e) {
        // Update animation speed
    });

    document.getElementById('showLegend').addEventListener('change', function(e) {
        chart.options.plugins.legend.display = e.target.checked;
        chart.update();
    });
</script>
{% endblock %}
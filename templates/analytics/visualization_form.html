{% extends 'base.html' %}
{% load static %}

{% block title %}Create Visualization - Analytics{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">Create New Visualization</h1>
        <div class="d-flex gap-2">
            <a href="{% url 'analytics:visualization_list' %}" class="btn btn-outline-primary">
                <i class="ri-arrow-left-line"></i> Back to Visualizations
            </a>
        </div>
    </div>

    <!-- Main Form Card -->
    <div class="widget-card">
        <form method="POST" class="needs-validation" novalidate>
            {% csrf_token %}
            
            <!-- Form Errors -->
            {% if form.non_field_errors %}
            <div class="alert alert-danger" role="alert">
                {% for error in form.non_field_errors %}
                    {{ error }}
                {% endfor %}
            </div>
            {% endif %}

            <!-- Title Field -->
            <div class="mb-4">
                <label for="{{ form.title.id_for_label }}" class="form-label">
                    Visualization Title <span class="text-danger">*</span>
                </label>
                <input type="text" 
                       class="form-control {% if form.title.errors %}is-invalid{% endif %}"
                       id="{{ form.title.id_for_label }}"
                       name="{{ form.title.name }}"
                       value="{{ form.title.value|default:'' }}"
                       required>
                {% if form.title.errors %}
                <div class="invalid-feedback">
                    {% for error in form.title.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- Dataset Field -->
            <div class="mb-4">
                <label for="{{ form.dataset.id_for_label }}" class="form-label">
                    Dataset <span class="text-danger">*</span>
                </label>
                <select class="form-select {% if form.dataset.errors %}is-invalid{% endif %}"
                        id="{{ form.dataset.id_for_label }}"
                        name="{{ form.dataset.name }}"
                        required>
                    <option value="">Select a dataset</option>
                    {% for value, label in form.dataset.field.choices %}
                    <option value="{{ value }}"
                            {% if value == form.dataset.value|stringformat:"s" %}selected{% endif %}>
                        {{ label }}
                    </option>
                    {% endfor %}
                </select>
                {% if form.dataset.errors %}
                <div class="invalid-feedback">
                    {% for error in form.dataset.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- Visualization Type Field -->
            <div class="mb-4">
                <label for="{{ form.visualization_type.id_for_label }}" class="form-label">
                    Visualization Type <span class="text-danger">*</span>
                </label>
                <select class="form-select {% if form.visualization_type.errors %}is-invalid{% endif %}"
                        id="{{ form.visualization_type.id_for_label }}"
                        name="{{ form.visualization_type.name }}"
                        required>
                    <option value="">Select a visualization type</option>
                    {% for value, label in form.visualization_type.field.choices %}
                    <option value="{{ value }}"
                            {% if value == form.visualization_type.value %}selected{% endif %}>
                        {{ label }}
                    </option>
                    {% endfor %}
                </select>
                {% if form.visualization_type.errors %}
                <div class="invalid-feedback">
                    {% for error in form.visualization_type.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- Configuration Field -->
            <div class="mb-4">
                <label for="{{ form.config.id_for_label }}" class="form-label">
                    Configuration
                </label>
                <textarea class="form-control {% if form.config.errors %}is-invalid{% endif %}"
                          id="{{ form.config.id_for_label }}"
                          name="{{ form.config.name }}"
                          rows="6"
                          placeholder="Enter JSON configuration">{{ form.config.value|default:'{}' }}</textarea>
                {% if form.config.errors %}
                <div class="invalid-feedback">
                    {% for error in form.config.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
                {% endif %}
                <div class="form-text">
                    Enter visualization configuration in JSON format. The required fields will depend on the selected visualization type.
                </div>
            </div>

            <!-- Form Actions -->
            <div class="d-flex gap-2 justify-content-end">
                <button type="button" 
                        class="btn btn-outline-secondary" 
                        onclick="history.back()">
                    Cancel
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="ri-line-chart-line"></i> Create Visualization
                </button>
            </div>
        </form>
    </div>

    <!-- Configuration Help Card -->
    <div class="widget-card mt-4">
        <h5 class="mb-3">Configuration Help</h5>
        <div class="config-help">
            <div class="accordion" id="configHelp">
                <!-- Bar Chart Config -->
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#barChartHelp">
                            Bar Chart Configuration
                        </button>
                    </h2>
                    <div id="barChartHelp" class="accordion-collapse collapse" data-bs-parent="#configHelp">
                        <div class="accordion-body">
                            <pre><code>{
    "xAxis": "field_name",
    "yAxis": "field_name",
    "groupBy": "field_name",
    "orientation": "vertical",
    "stacked": false,
    "colors": ["#hexcode", "#hexcode"]
}</code></pre>
                        </div>
                    </div>
                </div>

                <!-- Pie Chart Config -->
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#pieChartHelp">
                            Pie Chart Configuration
                        </button>
                    </h2>
                    <div id="pieChartHelp" class="accordion-collapse collapse" data-bs-parent="#configHelp">
                        <div class="accordion-body">
                            <pre><code>{
    "labels": "field_name",
    "values": "field_name",
    "donut": false,
    "colors": ["#hexcode", "#hexcode"]
}</code></pre>
                        </div>
                    </div>
                </div>

                <!-- More configuration help sections... -->
            </div>
        </div>
    </div>
</div>

<!-- Form Validation Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Form validation
    const forms = document.querySelectorAll('.needs-validation');
    Array.from(forms).forEach(form => {
        form.addEventListener('submit', event => {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);
    });

    // JSON validation for config field
    const configField = document.getElementById('{{ form.config.id_for_label }}');
    configField.addEventListener('change', function() {
        try {
            const config = JSON.parse(this.value);
            this.value = JSON.stringify(config, null, 2);
            this.classList.remove('is-invalid');
        } catch (e) {
            this.classList.add('is-invalid');
        }
    });

    // Update configuration help based on selected visualization type
    const vizTypeSelect = document.getElementById('{{ form.visualization_type.id_for_label }}');
    vizTypeSelect.addEventListener('change', function() {
        // Show/hide relevant configuration help sections based on selection
        const selectedType = this.value;
        document.querySelectorAll('.config-help .accordion-item').forEach(item => {
            item.style.display = 'none';
        });
        const helpSection = document.querySelector(`#${selectedType}Help`);
        if (helpSection) {
            helpSection.style.display = 'block';
        }
    });
});
</script>
{% endblock %}
{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    .question-container {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .choices-container {
        padding-left: 20px;
        margin-top: 10px;
    }

    .numeric-fields {
        display: none;
    }

    .delete-question {
        color: #dc3545;
        cursor: pointer;
    }

    .required-asterisk {
        color: #dc3545;
        margin-left: 4px;
    }

    .form-section {
        margin-bottom: 30px;
    }

    .question-type-help {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 5px;
    }

    .choices-list {
        list-style: none;
        padding: 0;
    }

    .choice-item {
        margin-bottom: 10px;
    }

    .add-choice-btn {
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <h1 class="mb-4">{% trans "Create New Poll" %}</h1>

    <form method="post" id="poll-form" class="needs-validation" novalidate>
        {% csrf_token %}

        <!-- Poll Details Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">{% trans "Poll Details" %}</h5>
            </div>
            <div class="card-body">
                {% if form.errors %}
                <div class="alert alert-danger">
                    {% trans "Please correct the errors below." %}
                </div>
                {% endif %}

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ form.title.id_for_label }}" class="form-label">
                                {% trans "Title" %}<span class="required-asterisk">*</span>
                            </label>
                            {{ form.title }}
                            {% if form.title.errors %}
                            <div class="invalid-feedback">{{ form.title.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ form.category.id_for_label }}" class="form-label">
                                {% trans "Category" %}
                            </label>
                            {{ form.category }}
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="{{ form.description.id_for_label }}" class="form-label">
                        {% trans "Description" %}
                    </label>
                    {{ form.description }}
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ form.start_date.id_for_label }}" class="form-label">
                                {% trans "Start Date" %}
                            </label>
                            {{ form.start_date }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ form.end_date.id_for_label }}" class="form-label">
                                {% trans "End Date" %}
                            </label>
                            {{ form.end_date }}
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ form.poll_type.id_for_label }}" class="form-label">
                                {% trans "Poll Type" %}
                            </label>
                            {{ form.poll_type }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ form.tags.id_for_label }}" class="form-label">
                                {% trans "Tags" %}
                            </label>
                            {{ form.tags }}
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4">
                        <div class="form-check">
                            {{ form.allow_comments }}
                            <label class="form-check-label" for="{{ form.allow_comments.id_for_label }}">
                                {% trans "Allow Comments" %}
                            </label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-check">
                            {{ form.allow_sharing }}
                            <label class="form-check-label" for="{{ form.allow_sharing.id_for_label }}">
                                {% trans "Allow Sharing" %}
                            </label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-check">
                            {{ form.restricted_to_institution }}
                            <label class="form-check-label" for="{{ form.restricted_to_institution.id_for_label }}">
                                {% trans "Restrict to Institution" %}
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Questions Section -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">{% trans "Questions" %}</h5>
                <button type="button" class="btn btn-primary btn-sm" id="add-question">
                    {% trans "Add Question" %}
                </button>
            </div>
            <div class="card-body">
                {{ question_formset.management_form }}
                <div id="questions-container">
                    {% for question_form in question_formset %}
                    <div class="question-container">
                        {{ question_form.id }}
                        <div class="mb-3">
                            <label class="form-label">{% trans "Question Text" %}<span class="required-asterisk">*</span></label>
                            {{ question_form.text }}
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">{% trans "Question Type" %}</label>
                                    {{ question_form.question_type }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">{% trans "Order" %}</label>
                                    {{ question_form.order }}
                                </div>
                            </div>
                        </div>
                        <div class="numeric-fields">
                            <div class="row">
                                <div class="col-md-4">
                                    {{ question_form.min_value }}
                                </div>
                                <div class="col-md-4">
                                    {{ question_form.max_value }}
                                </div>
                                <div class="col-md-4">
                                    {{ question_form.step_value }}
                                </div>
                            </div>
                        </div>
                        <div class="choices-container">
                            <div class="choices-list"></div>
                            <button type="button" class="btn btn-outline-secondary btn-sm add-choice-btn">
                                {% trans "Add Choice" %}
                            </button>
                        </div>
                        <div class="form-check mt-3">
                            {{ question_form.is_required }}
                            <label class="form-check-label">
                                {% trans "Required" %}
                            </label>
                        </div>
                        <button type="button" class="btn btn-danger btn-sm mt-3 delete-question">
                            {% trans "Delete Question" %}
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between">
            <a href="{% url 'polls:poll_list' %}" class="btn btn-secondary">
                {% trans "Cancel" %}
            </a>
            <button type="submit" class="btn btn-primary">
                {% trans "Create Poll" %}
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    $(document).ready(function() {
        // Initialize Select2 for tags
        $('.select2-tags').select2({
            tags: true,
            tokenSeparators: [',', ' ']
        });

        // Question type change handler
        function handleQuestionTypeChange(questionContainer) {
            const questionType = $(questionContainer).find('[name$="-question_type"]').val();
            const numericFields = $(questionContainer).find('.numeric-fields');
            const choicesContainer = $(questionContainer).find('.choices-container');

            numericFields.hide();
            choicesContainer.hide();

            if (questionType === 'rating' || questionType === 'numeric') {
                numericFields.show();
            } else if (questionType === 'single_choice' || questionType === 'multiple_choice') {
                choicesContainer.show();
            }
        }

        // Initialize existing questions
        $('.question-container').each(function() {
            handleQuestionTypeChange(this);
        });

        // Add question handler
        $('#add-question').click(function() {
            const totalForms = $('#id_question_set-TOTAL_FORMS');
            const newIndex = parseInt(totalForms.val());
            const template = $('.question-container').first().clone();

            // Clear values and update indices
            template.find('input, textarea, select').each(function() {
                const name = $(this).attr('name').replace('-0-', `-${newIndex}-`);
                $(this).attr('name', name).attr('id', `id_${name}`).val('');
            });

            $('#questions-container').append(template);
            totalForms.val(newIndex + 1);

            // Initialize the new question
            handleQuestionTypeChange(template);
        });

        // Delete question handler
        $(document).on('click', '.delete-question', function() {
            $(this).closest('.question-container').remove();
        });

        // Question type change event
        $(document).on('change', '[name$="-question_type"]', function() {
            handleQuestionTypeChange($(this).closest('.question-container'));
        });

        // Add choice handler
        $(document).on('click', '.add-choice-btn', function() {
            const choicesList = $(this).siblings('.choices-list');
            const choiceTemplate = `
                <div class="choice-item input-group mb-2">
                    <input type="text" class="form-control" name="choice_text" placeholder="{% trans "Enter choice text" %}">
                    <button type="button" class="btn btn-outline-danger delete-choice">×</button>
                </div>
            `;
            choicesList.append(choiceTemplate);
        });

        // Delete choice handler
        $(document).on('click', '.delete-choice', function() {
            $(this).closest('.choice-item').remove();
        });

        // Form submission handler
        $('#poll-form').submit(function(e) {
            // Collect choices data
            $('.question-container').each(function(index) {
                const questionType = $(this).find('[name$="-question_type"]').val();
                if (questionType === 'single_choice' || questionType === 'multiple_choice') {
                    const choices = [];
                    $(this).find('.choice-item input').each(function() {
                        choices.push($(this).val());
                    });
                    $(this).append(`<input type="hidden" name="question_${index}_choices" value="${choices.join('|')}">`);
                }
            });
        });
    });
</script>
{% endblock %}
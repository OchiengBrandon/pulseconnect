{# templates/polls/poll_results.html #}
{% extends "polls/base.html" %}
{% load i18n %}

{% block extra_css %}
{{ block.super }}
<style>
  .results-card {
    @apply bg-white rounded-xl shadow-lg p-6 mb-6;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
  }

  .chart-container {
    @apply relative bg-white rounded-lg p-4 mb-6;
    min-height: 300px;
  }

  .response-bar {
    @apply relative h-8 bg-gray-200 rounded-full overflow-hidden mb-4;
  }

  .response-bar-fill {
    @apply absolute top-0 left-0 h-full bg-blue-500 rounded-full transition-all duration-1000;
  }

  .response-label {
    @apply absolute inset-y-0 left-4 flex items-center text-sm font-medium;
  }

  .response-percentage {
    @apply absolute inset-y-0 right-4 flex items-center text-sm font-medium;
  }

  .stats-grid {
    @apply grid grid-cols-1 md:grid-cols-3 gap-6 mb-8;
  }

  .stat-card {
    @apply bg-white rounded-xl shadow-lg p-6 text-center;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
  }
</style>
{% endblock %}

{% block poll_content %}
<div class="max-w-4xl mx-auto">
  <!-- Poll Header -->
  <div class="results-card">
    <h1 class="text-3xl font-bold text-gray-900 mb-4">{{ poll.title }} - Results</h1>
    <p class="text-gray-600 mb-6">{{ poll.description }}</p>

    <!-- Statistics Overview -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="text-4xl font-bold text-blue-600 mb-2">{{ poll.total_responses }}</div>
        <div class="text-gray-500">{% trans "Total Responses" %}</div>
      </div>
      <div class="stat-card">
        <div class="text-4xl font-bold text-green-600 mb-2">{{ poll.total_participants }}</div>
        <div class="text-gray-500">{% trans "Unique Participants" %}</div>
      </div>
      <div class="stat-card">
        <div class="text-4xl font-bold text-purple-600 mb-2">
          {{ poll.questions.count }}
        </div>
        <div class="text-gray-500">{% trans "Questions" %}</div>
      </div>
    </div>
  </div>

  <!-- Question Results -->
  {% for question in poll.questions.all %}
  <div class="results-card">
    <h2 class="text-xl font-semibold text-gray-900 mb-6">{{ question.text }}</h2>

    {% if question.question_type.slug == 'single_choice' or question.question_type.slug == 'multiple_choice' %}
    <!-- Bar Chart -->
    <div class="chart-container">
      <canvas id="chart-{{ question.id }}"></canvas>
    </div>

    <!-- Detailed Breakdown -->
    <div class="space-y-4">
      {% for choice in question.choices.all %}
      {% with response_data=choice.response_data %}
      <div>
        <div class="flex justify-between text-sm text-gray-600 mb-1">
          <span>{{ choice.text }}</span>
          <span>{{ response_data.count }} responses</span>
        </div>
        <div class="response-bar">
          <div class="response-bar-fill" style="width: {{ response_data.percentage }}%"></div>
          <span class="response-label text-white">{{ choice.text }}</span>
          <span class="response-percentage text-gray-700">{{ response_data.percentage }}%</span>
        </div>
      </div>
      {% endwith %}
      {% endfor %}
    </div>

    {% elif question.question_type.slug == 'rating' %}
    <!-- Rating Distribution Chart -->
    <div class="chart-container">
      <canvas id="chart-{{ question.id }}"></canvas>
    </div>

    <div class="text-center mt-4">
      <div class="text-2xl font-bold text-gray-900">
        {{ question.average_rating|floatformat:1 }}
      </div>
      <div class="text-gray-500">{% trans "Average Rating" %}</div>
    </div>

    {% elif question.question_type.slug == 'text' %}
    <!-- Text Responses -->
    <div class="space-y-4">
      {% for response in question.responses.all %}
      <div class="bg-gray-50 rounded-lg p-4">
        <p class="text-gray-700">{{ response.response_data.text }}</p>
        <div class="text-sm text-gray-500 mt-2">
          {% if not poll.is_anonymous %}
          <span>{{ response.user.username }} - </span>
          {% endif %}
          <span>{{ response.created_at|date:"M d, Y H:i" }}</span>
        </div>
      </div>
      {% endfor %}
    </div>
    {% endif %}
  </div>
  {% endfor %}

  <!-- Share Results -->
  <div class="results-card">
    <h2 class="text-xl font-semibold text-gray-900 mb-4">{% trans "Share Results" %}</h2>
    <div class="flex space-x-4">
      <button class="btn-secondary" onclick="shareResults('twitter')">
        <i class="fab fa-twitter mr-2"></i> Twitter
      </button>
      <button class="btn-secondary" onclick="shareResults('facebook')">
        <i class="fab fa-facebook mr-2"></i> Facebook
      </button>
      <button class="btn-secondary" onclick="shareResults('linkedin')">
        <i class="fab fa-linkedin mr-2"></i> LinkedIn
      </button>
      <button class="btn-secondary" onclick="copyShareLink()">
        <i class="fas fa-link mr-2"></i> {% trans "Copy Link" %}
      </button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize charts for each question
  {% for question in poll.questions.all %}
  {% if question.question_type.slug == 'single_choice' or question.question_type.slug == 'multiple_choice' %}
  new Chart(document.getElementById('chart-{{ question.id }}').getContext('2d'), {
    type: 'bar',
    data: {
      labels: {{ question.chart_labels|safe }},
      datasets: [{
        label: '{% trans "Responses" %}',
        data: {{ question.chart_data|safe }},
        backgroundColor: 'rgba(59, 130, 246, 0.5)',
        borderColor: 'rgb(59, 130, 246)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            precision: 0
          }
        }
      }
    }
  });
  {% elif question.question_type.slug == 'rating' %}
  new Chart(document.getElementById('chart-{{ question.id }}').getContext('2d'), {
    type: 'line',
    data: {
      labels: {{ question.rating_labels|safe }},
      datasets: [{
        label: '{% trans "Distribution" %}',
        data: {{ question.rating_distribution|safe }},
        fill: true,
        backgroundColor: 'rgba(59, 130, 246, 0.2)',
        borderColor: 'rgb(59, 130, 246)',
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            precision: 0
          }
        }
      }
    }
  });
  {% endif %}
  {% endfor %}
});

// Share functionality
function shareResults(platform) {
  const url = window.location.href;
  const title = '{{ poll.title }}';
  
  let shareUrl;
  switch (platform) {
    case 'twitter':
      shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(title)}&url=${encodeURIComponent(url)}`;
      break;
    case 'facebook':
      shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
      break;
    case 'linkedin':
      shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}`;
      break;
  }
  
  window.open(shareUrl, '_blank');
}

function copyShareLink() {
  const url = window.location.href;
  navigator.clipboard.writeText(url).then(() => {
    alert('{% trans "Link copied to clipboard!" %}');
  });
}
</script>
{% endblock %}